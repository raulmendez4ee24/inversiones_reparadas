<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Onboarding | {{ payload.company_name }}</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <main class="page report">
    <header class="report-header">
      <div>
        <p class="pill">Onboarding</p>
        <h1>Accesos e implementacion</h1>
        <p class="lead">Folio #{{ lead_id }} · {{ payload.company_name }}</p>
      </div>
      <a class="ghost" href="/">Nueva auditoria</a>
    </header>

    <form class="onboarding-form" method="post" action="/implement">
      <input type="hidden" name="lead_id" value="{{ lead_id }}" />
      <div class="stepper" data-steps="5">
        <div class="stepper-header">
          <div>
            <p class="pill mini">Onboarding guiado</p>
            <h3>Completa el proceso sin complicaciones</h3>
          </div>
          <div class="stepper-counter">
            Paso <span class="step-current">1</span> de <span class="step-total">5</span>
          </div>
        </div>
        <div class="stepper-track">
          <div class="stepper-progress"></div>
        </div>
        <div class="stepper-labels">
          <span class="step-label active">Cuenta</span>
          <span class="step-label">Preferencias</span>
          <span class="step-label">Modulos</span>
          <span class="step-label">Activacion</span>
          <span class="step-label">Pago</span>
        </div>
      </div>

      <section class="form-step active" data-step="1">
        <details class="fold">
          <summary>Proceso claro (paso a paso)</summary>
          <ol class="roadmap">
            <li>
              <strong>Analisis IA</strong>
              <span>Detectamos que se puede automatizar en tu negocio.</span>
            </li>
            <li>
              <strong>Seleccion de modulos</strong>
              <span>Elegimos los flujos exactos que necesitas.</span>
            </li>
            <li>
              <strong>Accesos seguros</strong>
              <span>Conectamos tus cuentas en una sesion guiada (sin tecnicismos).</span>
            </li>
            <li>
              <strong>Contrato y pago</strong>
              <span>Autorizas el inicio y se emite el contrato.</span>
            </li>
            <li>
              <strong>Implementacion</strong>
              <span>Construimos flujos en n8n, probamos y dejamos todo funcionando.</span>
            </li>
          </ol>
        </details>

        <details class="fold">
          <summary>Explicacion simple</summary>
          <p class="meta">
            No necesitas saber que es una API. Para ti es asi:
            nos autorizas y en una llamada de 15 minutos conectamos tus cuentas de forma segura.
          </p>
          <ul>
            <li>Tu eliges que quieres automatizar.</li>
            <li>Nosotros armamos los flujos en n8n y conectamos tus sistemas.</li>
            <li>Todo queda documentado y puedes revocar permisos cuando quieras.</li>
          </ul>
          <p class="meta">
            Lo minimo que pedimos en la sesion: acceso a tus cuentas (por invitacion o autorizacion en pantalla).
          </p>
        </details>

        {% if access_code %}
        <section class="card highlight">
          <h3>Portal seguro del cliente</h3>
          <p class="meta">
            Este codigo es unico para tu empresa y sirve como respaldo. Guardalo: no lo mostraremos otra vez.
          </p>
          <div class="kpi">
            <span>Codigo de respaldo</span>
            <strong>{{ access_code }}</strong>
          </div>
          <p class="meta">Entra al portal cuando quieras desde /portal.</p>
        </section>
        {% endif %}

        <section class="card">
          <h3>Cuenta de acceso (obligatorio)</h3>
          <p class="meta">
            Para seguridad y seguimiento, crea tu acceso con correo y contrasena.
          </p>
          <div class="grid">
            <label>
              Correo de acceso
              <input type="email" name="portal_email" placeholder="tu@empresa.com" value="{{ payload.contact_email or '' }}" required />
            </label>
            <label>
              Contrasena
              <input type="password" name="portal_password" placeholder="Minimo 6 caracteres" required />
            </label>
            <label>
              Confirmar contrasena
              <input type="password" name="portal_password_confirm" placeholder="Repite tu contrasena" required />
            </label>
          </div>
          <label class="consent">
            <input type="checkbox" name="marketing_opt_in" id="marketing-opt-in" />
            <span>Acepto recibir comunicados, novedades y promociones relacionadas (opcional).</span>
          </label>
          <label>
            Canal preferido (solo si activas comunicados)
            <select name="marketing_channel" id="marketing-channel" disabled>
              <option value="">Selecciona una opcion</option>
              <option value="email">Email</option>
              <option value="whatsapp">WhatsApp</option>
            </select>
          </label>
        </section>
      </section>

      <section class="form-step" data-step="2">
        <section class="card">
          <h3>Preferencias de entrega</h3>
          <p class="meta">Selecciona como quieres recibir resultados y automatizaciones.</p>
          <div class="module-grid">
            <label class="module-choice">
              <input type="checkbox" name="delivery_channels" value="whatsapp_total" />
              <span>Todo por WhatsApp</span>
              <small>Mensajes y avisos en WhatsApp.</small>
            </label>
            <label class="module-choice">
              <input type="checkbox" name="delivery_channels" value="pdf" />
              <span>Reporte en PDF</span>
              <small>Documento descargable.</small>
            </label>
            <label class="module-choice">
              <input type="checkbox" name="delivery_channels" value="pdf_whatsapp" />
              <span>PDF por WhatsApp</span>
              <small>Recibe el PDF directo en WhatsApp.</small>
            </label>
            <label class="module-choice">
              <input type="checkbox" name="delivery_channels" value="email" />
              <span>Correo</span>
              <small>Resumenes por email.</small>
            </label>
          </div>
        </section>

        <section class="card">
          <h3>Tipo de bot o asistente</h3>
          <p class="meta">Marca lo que quieres implementar.</p>
          <div class="module-grid">
            <label class="module-choice">
              <input type="checkbox" name="bot_preferences" value="chatbot" />
              <span>Chatbot de atencion</span>
              <small>Responde preguntas frecuentes y soporte.</small>
            </label>
            <label class="module-choice">
              <input type="checkbox" name="bot_preferences" value="ventas" />
              <span>Bot de ventas</span>
              <small>Califica leads y agenda.</small>
            </label>
            <label class="module-choice">
              <input type="checkbox" name="bot_preferences" value="agente_operativo" />
              <span>Agente operativo</span>
              <small>Reportes, alertas y tareas internas.</small>
            </label>
          </div>
        </section>
      </section>

      <section class="form-step" data-step="3">
        <section class="card">
          <h3>Selecciona los modulos a implementar</h3>
          <div class="module-grid">
            {% for module in modules %}
            <label class="module-choice">
              <input type="checkbox" name="selected_modules" value="{{ module.name }}" {% if module.name in recommended %}checked{% endif %} />
              <span>{{ module.name }}</span>
              <small>{{ module.description }}</small>
            </label>
            {% endfor %}
          </div>
        </section>
      </section>

      <section class="form-step" data-step="4">
        <section class="card">
          <h3>Arquitecto de implementacion: {{ founder.name if founder else "Arquitecto K'an" }} (15 min)</h3>
          <p class="meta">
            En esta llamada yo (tu arquitecto) conecto tus cuentas en pantalla de forma segura y dejamos
            el proyecto listo para construir. No te vamos a pedir tokens ni API keys por chat.
          </p>

          <div class="founder-actions">
            {% if founder and (founder.calendar_url or founder.whatsapp) %}
              <a class="button-link" href="/agenda?lead_id={{ lead_id }}&company={{ payload.company_name | urlencode }}&source=onboarding" target="_blank" rel="noopener noreferrer">Agendar sesion</a>
            {% endif %}
            {% if founder and founder.whatsapp %}
              {% set wa_text = ("Hola, quiero agendar mi sesion de activacion. Folio " ~ lead_id ~ " (" ~ payload.company_name ~ ")") %}
              <a class="mini-btn" href="https://wa.me/{{ founder.whatsapp | replace('+','') | replace(' ','') }}?text={{ wa_text | urlencode }}" target="_blank" rel="noopener">Agendar por WhatsApp</a>
            {% endif %}
          </div>
          <p class="meta">Agenda tu sesion y regresa aqui para continuar al paso de pago.</p>

          <div class="meta">
            <strong>Que pasa en la sesion</strong>
          </div>
          <ol class="roadmap">
            <li>Confirmamos alcance (lo que marcaste + tus dolores reales).</li>
            <li>Conectamos cuentas en pantalla con permisos revocables.</li>
            <li>Definimos entregables, responsables y fecha de entrega.</li>
          </ol>
        </section>
      </section>

      <section class="form-step" data-step="5">
        <section class="card">
          <h3>Contrato y pago</h3>
          <p class="meta">
            Al enviar esta solicitud generamos el contrato y el link de pago. Solo trabajamos con
            autorizacion por escrito.
          </p>
          <label>
            Metodo de pago preferido
            <select name="payment_method">
              <option value="">Selecciona una opcion</option>
              <option value="tarjeta">Tarjeta</option>
              <option value="transferencia">Transferencia</option>
            </select>
          </label>
          <label class="consent">
            <input type="checkbox" name="consent" required />
            <span>Acepto que K'an Logic Systems genere el contrato y reciba el pago para iniciar la implementacion.</span>
          </label>
        </section>

        <section class="card">
          <h3>Notas adicionales</h3>
          <textarea name="notes" rows="4" placeholder="Cualquier detalle adicional para el equipo tecnico"></textarea>
          <label class="consent">
            <input type="checkbox" name="access_consent" required />
            <span>Autorizo a K'an Logic Systems a usar estos accesos para implementar automatizaciones.</span>
          </label>
        </section>
      </section>

      <div class="step-actions">
        <button type="button" class="ghost-btn step-prev">Atras</button>
        <button type="button" class="step-next">Siguiente</button>
        <button type="submit" class="step-submit">Continuar a pago</button>
      </div>
    </form>

    <footer class="site-footer">
      <span>© 2026 K'an Logic Systems</span>
      <span class="footer-links">
        <a href="/privacy">Privacidad</a>
        <a href="/terms">Terminos</a>
        <a href="/contact">Contacto</a>
        <a href="/about">Nosotros</a>
        <a href="/data-deletion">Eliminacion de datos</a>
      </span>
    </footer>
  </main>

  {% if founder and founder.whatsapp %}
  <a href="https://wa.me/{{ founder.whatsapp | replace('+','') | replace(' ','') }}" class="whatsapp-float" target="_blank" rel="noopener" aria-label="Contactar por WhatsApp">
    <svg viewBox="0 0 32 32" class="whatsapp-icon"><path d="M16 2C8.28 2 2 8.28 2 16c0 2.5.66 4.85 1.82 6.88L2.5 29.5l6.62-1.32C11.15 29.34 13.5 30 16 30c7.72 0 14-6.28 14-14S23.72 2 16 2zm0 25.5c-2.16 0-4.2-.58-6-1.6l-.43-.25-3.75.75.75-3.75-.25-.43C5.58 20.2 5 18.16 5 16c0-6.08 4.92-11 11-11s11 4.92 11 11-4.92 11-11 11zm5.88-8.25c-.32-.16-1.92-.95-2.22-1.06-.3-.11-.52-.16-.74.16-.22.32-.85 1.06-1.04 1.28-.19.22-.38.25-.7.09-.32-.16-1.35-.5-2.57-1.58-.95-.85-1.6-1.9-1.78-2.22-.19-.32-.02-.49.14-.65.14-.14.32-.38.48-.56.16-.19.22-.32.33-.54.11-.22.06-.41-.03-.58-.09-.17-.74-1.78-1.01-2.44-.26-.64-.53-.55-.74-.56h-.63c-.22 0-.58.08-.88.41-.3.32-1.14 1.11-1.14 2.72s1.17 3.16 1.33 3.38c.16.22 2.3 3.51 5.57 4.92 2.18.94 3.03.94 4.13.79 1.22-.17 2.64-1.08 3.01-2.12.37-1.04.37-1.93.26-2.12-.11-.19-.41-.3-.73-.46z" fill="#FFF"/></svg>
  </a>
  <style>
    .whatsapp-float {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background-color: #25d366;
      color: #fff;
      border-radius: 50%;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      text-decoration: none;
    }
    .whatsapp-float:hover {
      transform: scale(1.1);
      background-color: #128c7e;
    }
    .whatsapp-icon {
      width: 35px;
      height: 35px;
      fill: #fff;
    }
  </style>
  {% endif %}

  <script>
    const form = document.querySelector(".onboarding-form");

    // (Opcional) Si en el futuro agregas secciones condicionadas por modulo, esto no debe romper.
    const moduleInputs = Array.from(document.querySelectorAll('input[name="selected_modules"]'));
    const accessItems = Array.from(document.querySelectorAll('.access-item'));

    function refreshAccess() {
      if (!accessItems.length || !moduleInputs.length) return;
      const selected = moduleInputs.filter((input) => input.checked).map((input) => input.value);
      accessItems.forEach((item) => {
        const modules = item.dataset.modules ? item.dataset.modules.split('|') : [];
        const show = modules.length === 0 || modules.some((moduleName) => selected.includes(moduleName));
        item.style.display = show ? 'block' : 'none';
      });
    }

    moduleInputs.forEach((input) => input.addEventListener('change', refreshAccess));
    refreshAccess();

    if (form) {
      const marketingOptIn = form.querySelector("#marketing-opt-in");
      const marketingChannel = form.querySelector("#marketing-channel");

      const syncMarketingChannel = () => {
        if (!marketingChannel) return;
        const enabled = !!(marketingOptIn && marketingOptIn.checked);
        marketingChannel.disabled = !enabled;
        if (!enabled) marketingChannel.value = "";
      };

      marketingOptIn?.addEventListener("change", syncMarketingChannel);
      syncMarketingChannel();

      const steps = Array.from(form.querySelectorAll(".form-step"));
      const labels = Array.from(form.querySelectorAll(".step-label"));
      const progress = form.querySelector(".stepper-progress");
      const currentEl = form.querySelector(".step-current");
      const totalEl = form.querySelector(".step-total");
      const prevBtn = form.querySelector(".step-prev");
      const nextBtn = form.querySelector(".step-next");
      const submitBtn = form.querySelector(".step-submit");
      const fields = Array.from(form.querySelectorAll("input, textarea, select"));

      // Guardamos que campos eran required originalmente
      fields.forEach((field) => {
        if (field.required) field.dataset.required = "1";
      });

      let index = 0;
      const total = steps.length;
      if (totalEl) totalEl.textContent = String(total);

      const updateRequired = () => {
        steps.forEach((step, idx) => {
          const active = idx === index;
          step.querySelectorAll("input, textarea, select").forEach((field) => {
            if (field.dataset.required === "1") field.required = active;
          });
        });
      };

      const updateUI = () => {
        steps.forEach((step, idx) => step.classList.toggle("active", idx === index));
        labels.forEach((label, idx) => label.classList.toggle("active", idx === index));
        if (currentEl) currentEl.textContent = String(index + 1);
        if (progress) {
          const pct = total <= 1 ? 100 : (index / (total - 1)) * 100;
          progress.style.width = `${pct}%`;
        }

        if (prevBtn) {
          prevBtn.disabled = index === 0;
          prevBtn.style.opacity = index === 0 ? "0.5" : "1";
        }
        if (nextBtn) nextBtn.style.display = index === total - 1 ? "none" : "inline-flex";
        if (submitBtn) submitBtn.style.display = index === total - 1 ? "inline-flex" : "none";

        updateRequired();
      };

      const validateStep = () => {
        const currentFields = Array.from(steps[index].querySelectorAll("input, textarea, select"));
        for (const field of currentFields) {
          if (!field.checkValidity()) {
            field.reportValidity();
            return false;
          }
        }

        const pwd = form.querySelector("input[name='portal_password']");
        const confirm = form.querySelector("input[name='portal_password_confirm']");
        if (pwd && confirm && pwd.value && confirm.value && pwd.value !== confirm.value) {
          confirm.setCustomValidity("Las contrasenas no coinciden.");
          confirm.reportValidity();
          confirm.setCustomValidity("");
          return false;
        }

        return true;
      };

      prevBtn?.addEventListener("click", () => {
        index = Math.max(0, index - 1);
        updateUI();
      });

      nextBtn?.addEventListener("click", () => {
        if (!validateStep()) return;
        index = Math.min(total - 1, index + 1);
        updateUI();
      });

      form.addEventListener("submit", (event) => {
        if (!validateStep()) {
          event.preventDefault();
          return;
        }

        // UX: al enviar, desactivamos boton y mostramos estado.
        const submit = form.querySelector(".step-submit");
        if (submit) {
          submit.disabled = true;
          submit.textContent = "Preparando pago...";
        }
      });

      updateUI();
    }
  </script>
</body>
</html>
