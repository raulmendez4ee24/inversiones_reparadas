<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Implementacion enviada</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <main class="page report">
    <header class="report-header">
      <div>
        <p class="pill">Implementacion</p>
        <h1>Solicitud recibida</h1>
        {% if payload %}
        <p class="lead">
          Folio #{{ lead_id }}{% if project_id %} · Proyecto #{{ project_id }}{% endif %}
        </p>
        {% endif %}
      </div>
      <a class="ghost" href="/">Nueva auditoria</a>
    </header>

    {% if error %}
      <section class="card">
        <h3>Error</h3>
        <p>{{ error }}</p>
      </section>
    {% else %}
      <section class="card">
        <h3>Estado del handoff</h3>
        {% if consent %}
          {% if webhook_configured %}
            {% if webhook_status.startswith("sent") %}
              <p>Se envio a automatizacion ({{ webhook_status }}).</p>
            {% elif webhook_status == "failed" %}
              <p>El webhook fallo. El proyecto quedo guardado localmente.</p>
            {% else %}
              <p>Webhook configurado, pendiente.</p>
            {% endif %}
          {% else %}
            <p>Webhook no configurado. El proyecto quedo guardado localmente.</p>
          {% endif %}
          {% if payment_method %}
            <p class="meta">Metodo de pago: {{ payment_method }}</p>
          {% endif %}
        {% else %}
          <p>Falta autorizacion del cliente para contrato y/o acceso.</p>
        {% endif %}
        {% if login_warning %}
          <p class="meta" style="color:#9b3b2b;">{{ login_warning }}</p>
        {% endif %}
        {% if security_warning %}
          <p class="meta" style="color:#9b3b2b;">{{ security_warning }}</p>
        {% endif %}
        {% if is_express %}
        <p class="meta">
          Paso final: completa tu pago mensual express y activamos tu implementacion.
        </p>
        {% else %}
        <p class="meta">
          Siguiente paso: agenda tu sesion de Activacion (15 min). En esa llamada conectamos tus cuentas de forma segura
          y confirmamos entregables.
        </p>
        {% endif %}
        {% if consent %}
          {% if payment_method == "tarjeta" and mp_checkout_enabled %}
            <div class="founder-actions">
              <button type="button" class="button-link js-mp-open">Pagar con tarjeta</button>
              {% if payment_url %}
                <a class="ghost js-pay-now" href="{{ payment_url }}" rel="noopener">Usar link directo</a>
              {% endif %}
            </div>
            <p class="meta">Pago seguro con Mercado Pago dentro de esta pantalla.</p>
          {% elif payment_url %}
            <div class="founder-actions">
              <a class="button-link js-pay-now" href="{{ payment_url }}" rel="noopener">Ir a pagar ahora</a>
            </div>
            <p class="meta">Completa el pago para continuar con la implementacion.</p>
          {% else %}
            <p class="meta" style="color:#9b3b2b;">
              Falta configurar el link de pago. Define `PAYMENT_URL_CARD` y/o `PAYMENT_URL_TRANSFER`.
            </p>
          {% endif %}
        {% endif %}
        {% if not is_express %}
          <div class="founder-actions">
            {% if founder and (founder.calendar_url or founder.whatsapp) %}
              <a class="button-link" href="/agenda?lead_id={{ lead_id }}&company={{ payload.company_name | urlencode }}&source=implement" target="_blank" rel="noopener noreferrer">Agendar sesion</a>
            {% endif %}
            {% if founder and founder.whatsapp %}
              {% set wa_text = ("Hola, quiero agendar mi sesion de Activacion. Proyecto " ~ project_id ~ " (Folio " ~ lead_id ~ ").") %}
              <a class="mini-btn" href="https://wa.me/{{ founder.whatsapp | replace('+','') | replace(' ','') }}?text={{ wa_text | replace(' ', '%20') | replace('(', '%28') | replace(')', '%29') }}" target="_blank" rel="noopener">Agendar por WhatsApp</a>
            {% endif %}
          </div>
          <p class="meta">Agenda tu sesion de activacion para cerrar este paso.</p>
        {% endif %}
      </section>

      <section class="report-grid">
        <article class="card">
          <h3>Modulos seleccionados</h3>
          <ul>
            {% for module in selected_modules %}
              <li>{{ module }}</li>
            {% endfor %}
          </ul>
        </article>
        <article class="card">
          <h3>Preferencias</h3>
          {% if delivery_channels %}
            <p class="meta">Entrega:</p>
            <ul>
              {% for channel in delivery_channels %}
                <li>{{ channel }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="meta">Sin preferencias de entrega.</p>
          {% endif %}

          {% if bot_preferences %}
            <p class="meta">Bots solicitados:</p>
            <ul>
              {% for bot in bot_preferences %}
                <li>{{ bot }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="meta">Sin bots seleccionados.</p>
          {% endif %}
        </article>
        <article class="card">
          <h3>Resumen de retorno</h3>
          <div class="kpi">
            <span>Ganancia mensual proyectada</span>
            <strong>${{ output.roi_mxn_saved_per_month | round(0) }} MXN</strong>
          </div>
          <div class="kpi">
            {% if is_express %}
            <span>Mensualidad (MXN/mes)</span>
            <strong>${{ pay_amount_mxn }} MXN/mes</strong>
            {% else %}
            <span>Inversion unica (MXN)</span>
            <strong>${{ pay_amount_mxn }} MXN</strong>
            {% endif %}
          </div>
        </article>
      </section>
    {% endif %}

    <footer class="site-footer">
      <span>© 2026 K'an Logic Systems</span>
      <span class="footer-links">
        <a href="/privacy">Privacidad</a>
        <a href="/terms">Terminos</a>
        <a href="/contact">Contacto</a>
        <a href="/about">Nosotros</a>
        <a href="/data-deletion">Eliminacion de datos</a>
      </span>
    </footer>
  </main>
  {% if consent and payment_method == "tarjeta" and mp_checkout_enabled %}
  <div class="modal-backdrop" id="mpCheckoutModal" hidden>
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="mpCheckoutTitle">
      <button type="button" class="modal-close js-mp-close" aria-label="Cerrar">x</button>
      <p class="pill mini">Pago seguro</p>
      <h3 id="mpCheckoutTitle">Checkout Mercado Pago</h3>
      <p class="meta">
        {% if is_express %}
        Total mensual: <strong>${{ pay_amount_mxn }} MXN/mes</strong>.
        {% else %}
        Total: <strong>${{ pay_amount_mxn }} MXN</strong>.
        {% endif %}
      </p>
      <div id="mpCheckoutContainer"></div>
      <p class="meta" id="mpCheckoutStatus"></p>
    </div>
  </div>
  <script src="https://sdk.mercadopago.com/js/v2"></script>
  <script>
    (function () {
      const openBtn = document.querySelector(".js-mp-open");
      const modal = document.getElementById("mpCheckoutModal");
      const closeBtn = document.querySelector(".js-mp-close");
      const container = document.getElementById("mpCheckoutContainer");
      const statusEl = document.getElementById("mpCheckoutStatus");
      const leadId = {{ lead_id }};
      const projectId = {{ project_id }};
      const payerEmail = {{ (payload.contact_email or "") | tojson }};
      const checkoutToken = {{ (mp_checkout_token or "") | tojson }};
      let mpInstance = null;

      function setStatus(text, isError) {
        if (!statusEl) return;
        statusEl.textContent = text || "";
        statusEl.style.color = isError ? "#9b3b2b" : "#5a6d92";
      }

      function closeModal() {
        if (!modal) return;
        modal.hidden = true;
      }

      async function openCheckout() {
        if (!modal || !container) return;
        modal.hidden = false;
        setStatus("Preparando checkout seguro...", false);
        container.innerHTML = "";

        try {
          if (!checkoutToken) {
            setStatus("No se pudo iniciar el checkout seguro. Recarga la pagina.", true);
            return;
          }
          const response = await fetch("/api/payments/mercadopago/preference", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              lead_id: leadId,
              project_id: projectId,
              checkout_token: checkoutToken,
              payer_email: payerEmail || null,
              payment_method: "tarjeta",
            }),
          });
          const data = await response.json();
          if (!response.ok || !data.ok || !data.preference_id || !data.public_key) {
            const code = data && data.error ? String(data.error) : "checkout_error";
            const extra = data && data.detail ? ` (${String(data.detail).slice(0, 160)})` : "";
            setStatus("No se pudo abrir el checkout: " + code + extra, true);
            return;
          }

          mpInstance = new MercadoPago(data.public_key, { locale: "es-MX" });
          mpInstance.checkout({
            preference: { id: data.preference_id },
            render: {
              container: "#mpCheckoutContainer",
              label: "Pagar ahora",
            },
            autoOpen: true,
          });
          setStatus("Checkout listo. Completa el pago para continuar.", false);
        } catch (error) {
          setStatus("Error al conectar con Mercado Pago.", true);
        }
      }

      openBtn?.addEventListener("click", openCheckout);
      closeBtn?.addEventListener("click", closeModal);
      modal?.addEventListener("click", (event) => {
        if (event.target === modal) closeModal();
      });
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") closeModal();
      });
    })();
  </script>
  {% elif consent and payment_url %}
  <script>
    // Fallback para metodos sin modal (ej. transferencia).
    const payLink = document.querySelector(".js-pay-now");
    if (payLink && !payLink.getAttribute("target")) {
      payLink.setAttribute("target", "_self");
    }
  </script>
  {% endif %}
</body>
</html>
