<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Implementacion enviada</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <main class="page report">
    <header class="report-header">
      <div>
        <p class="pill">Implementacion</p>
        <h1>Solicitud recibida</h1>
        {% if payload %}
        <p class="lead">
          Folio #{{ lead_id }}{% if project_id %} · Proyecto #{{ project_id }}{% endif %}
        </p>
        {% endif %}
      </div>
      <a class="ghost" href="/">Nueva auditoria</a>
    </header>

    {% if error %}
      <section class="card">
        <h3>Error</h3>
        <p>{{ error }}</p>
      </section>
    {% else %}
      <section class="card">
        <h3>Estado del handoff</h3>
        {% if consent %}
          {% if webhook_configured %}
            {% if webhook_status.startswith("sent") %}
              <p>Se envio a automatizacion ({{ webhook_status }}).</p>
            {% elif webhook_status == "failed" %}
              <p>El webhook fallo. El proyecto quedo guardado localmente.</p>
            {% else %}
              <p>Webhook configurado, pendiente.</p>
            {% endif %}
          {% else %}
            <p>Webhook no configurado. El proyecto quedo guardado localmente.</p>
          {% endif %}
          {% if payment_method %}
            <p class="meta">Metodo de pago: {{ payment_method }}</p>
          {% endif %}
        {% else %}
          <p>Falta autorizacion del cliente para contrato y/o acceso.</p>
        {% endif %}
        {% if login_warning %}
          <p class="meta" style="color:#9b3b2b;">{{ login_warning }}</p>
        {% endif %}
        {% if security_warning %}
          <p class="meta" style="color:#9b3b2b;">{{ security_warning }}</p>
        {% endif %}
        <p class="meta">
          Siguiente paso: agenda tu sesion de Activacion (15 min). En esa llamada conectamos tus cuentas de forma segura
          y confirmamos entregables.
        </p>
        {% if consent and payment_url %}
          <div class="founder-actions">
            <a class="button-link js-pay-now" href="{{ payment_url }}" target="_blank" rel="noopener">Ir a pagar ahora</a>
          </div>
          <p class="meta">Te abrimos el checkout en una nueva pestana para completar el pago.</p>
        {% elif consent %}
          <p class="meta" style="color:#9b3b2b;">
            Falta configurar el link de pago. Define `PAYMENT_URL_CARD` y/o `PAYMENT_URL_TRANSFER`.
          </p>
        {% endif %}
        <div class="founder-actions">
          {% if founder and founder.calendar_url %}
            <a class="button-link" href="{{ founder.calendar_url }}" target="_blank" rel="noopener">Agendar por calendario</a>
          {% endif %}
          {% if founder and founder.whatsapp %}
            {% set wa_text = ("Hola, quiero agendar mi sesion de Activacion. Proyecto " ~ project_id ~ " (Folio " ~ lead_id ~ ").") %}
            <a class="mini-btn" href="https://wa.me/{{ founder.whatsapp | replace('+','') | replace(' ','') }}?text={{ wa_text | replace(' ', '%20') | replace('(', '%28') | replace(')', '%29') }}" target="_blank" rel="noopener">Agendar por WhatsApp</a>
          {% endif %}
        </div>
      </section>

      <section class="report-grid">
        <article class="card">
          <h3>Modulos seleccionados</h3>
          <ul>
            {% for module in selected_modules %}
              <li>{{ module }}</li>
            {% endfor %}
          </ul>
        </article>
        <article class="card">
          <h3>Preferencias</h3>
          {% if delivery_channels %}
            <p class="meta">Entrega:</p>
            <ul>
              {% for channel in delivery_channels %}
                <li>{{ channel }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="meta">Sin preferencias de entrega.</p>
          {% endif %}

          {% if bot_preferences %}
            <p class="meta">Bots solicitados:</p>
            <ul>
              {% for bot in bot_preferences %}
                <li>{{ bot }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="meta">Sin bots seleccionados.</p>
          {% endif %}
        </article>
        <article class="card">
          <h3>Resumen de retorno</h3>
          <div class="kpi">
            <span>Ganancia mensual proyectada</span>
            <strong>${{ output.roi_mxn_saved_per_month | round(0) }} MXN</strong>
          </div>
          <div class="kpi">
            <span>Inversion unica (MXN)</span>
            <strong>${{ output.pricing.setup_fee_mxn }} MXN</strong>
          </div>
        </article>
      </section>
    {% endif %}

    <footer class="site-footer">
      <span>© 2026 K'an Logic Systems</span>
      <span class="footer-links">
        <a href="/privacy">Privacidad</a>
        <a href="/terms">Terminos</a>
        <a href="/data-deletion">Eliminacion de datos</a>
      </span>
    </footer>
  </main>
  {% if consent and payment_url %}
  <script>
    window.setTimeout(() => {
      window.location.href = "{{ payment_url }}";
    }, 700);
  </script>
  {% endif %}
</body>
</html>
