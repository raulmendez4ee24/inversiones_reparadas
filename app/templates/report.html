<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reporte IA | {{ payload.company_name }}</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <main class="page report">
    <header class="report-header">
      <div>
        <p class="pill">Auditoria IA</p>
        <h1>{{ payload.company_name }}</h1>
        <p class="lead">{{ payload.industry }} · {{ payload.region }}</p>
      </div>
      <a class="ghost" href="/">Nueva auditoria</a>
    </header>

    {% set jornadas_mes = (output.roi_hours_saved_per_month / 8) if output.roi_hours_saved_per_month else 0 %}

    <section class="executive-board">
      <article class="exec-tile">
        <span>Paquete sugerido</span>
        <strong>{{ output.pricing.service_tier if output.pricing.service_tier else "Personalizado" }}</strong>
        <small>Recomendado por escala, volumen y herramientas actuales.</small>
      </article>
      <article class="exec-tile">
        <span>Inversion inicial</span>
        <strong>${{ output.pricing.setup_fee_mxn | round(0) }} MXN</strong>
        <small>Con criterio ROI y ajuste de oferta irresistible.</small>
      </article>
      <article class="exec-tile">
        <span>Payback conservador</span>
        <strong>{{ output.payback_months }} meses</strong>
        <small>Sin incluir el upside de oportunidad en ventas.</small>
      </article>
      <article class="exec-tile">
        <span>Impacto anual estimado</span>
        <strong>${{ output.roi_total_with_opportunity_mxn_per_year | round(0) }} MXN</strong>
        <small>Tiempo + errores evitados + oportunidad comercial.</small>
      </article>
    </section>

    <section class="report-grid">
      <article class="card highlight">
        <h3>Fuga de Capital Detectada</h3>
        <div class="kpi big">
          <span>Impacto anual proyectado</span>
          <strong>${{ output.roi_total_with_opportunity_mxn_per_year | round(0) }} MXN</strong>
        </div>
        <div class="kpi">
          <span>Ahorro recurrente (conservador)</span>
          <strong>${{ output.roi_mxn_saved_per_month | round(0) }} MXN/mes</strong>
        </div>
        <div class="kpi">
          <span>Impacto en ventas/atencion (oportunidad)</span>
          <strong>${{ output.roi_opportunity_mxn_per_month | round(0) }} MXN/mes</strong>
        </div>
        <div class="kpi">
          <span>Riesgo de error humano (impacto)</span>
          <strong>${{ output.roi_error_cost_mxn_per_month | round(0) }} MXN/mes</strong>
        </div>
        <p class="meta">
          Esto es dinero que hoy se va en procesos manuales + errores + lo que dejas de ganar por tener a tu equipo
          ocupado en Excel en lugar de vender o atender.
        </p>
      </article>

      <article class="card">
        <h3>El diagnostico</h3>
        <p class="meta"><strong>¿Cuantos dias de sueldo estas regalando al mes?</strong></p>
        <div class="kpi big">
          <span>Jornadas laborales completas (8h)</span>
          <strong>{{ jornadas_mes | round(1) }} dias/mes</strong>
        </div>
        <div class="kpi">
          <span>Sueldo regalado (solo tiempo)</span>
          <strong>${{ output.roi_time_value_mxn_per_month | round(0) }} MXN/mes</strong>
        </div>
        <p class="meta">
          Para estimar usamos un costo promedio por dia de <strong>${{ output.roi_loaded_daily_cost_mxn | round(0) }} MXN</strong>
          (sueldo neto + carga prestacional ~30%).
        </p>
        <p class="meta">Equivale a {{ output.roi_fte_equivalent }} personas de tiempo completo.</p>
      </article>
    </section>

    <section class="compare-grid">
      <article class="card money problem">
        <h3>Lo que estas dejando de ganar al año</h3>
        <p class="money-amount">${{ output.roi_total_with_opportunity_mxn_per_year | round(0) }} MXN</p>
        <p class="meta">
          Incluye sueldos regalados + reduccion de errores + costo de oportunidad (ventas/atencion).
        </p>
        <p class="meta">
          Riesgo de error humano (impacto): ${{ (output.roi_error_cost_mxn_per_month * 12) | round(0) }} MXN/año.
        </p>
      </article>
      <article class="card money solution">
        <h3>Solucion K'an</h3>
        <p class="money-amount">${{ output.pricing.setup_fee_mxn }} MXN</p>
        {% if output.pricing.service_tier %}
        <p class="meta">
          Paquete sugerido: <strong>{{ output.pricing.service_tier }}</strong>
          {% if output.pricing.suggested_range_min_mxn and output.pricing.suggested_range_max_mxn %}
          (rango ${{ output.pricing.suggested_range_min_mxn }} - ${{ output.pricing.suggested_range_max_mxn }} MXN).
          {% endif %}
        </p>
        {% endif %}
        <p class="meta">
          Inversion unica para construir tu infraestructura de automatizacion y dejarla operando.
        </p>
        <p class="meta">
          <strong>Payback conservador:</strong> {{ output.payback_months }} meses (sin contar el potencial extra en ventas).
        </p>
      </article>
    </section>

    <section class="card action-panel">
      <h3>Recomendacion ejecutiva</h3>
      <p class="meta">
        Si quieres velocidad, empieza con una implementacion express y escalamos a una arquitectura completa en fases.
        Si quieres impacto mayor desde el dia uno, vamos directo al paquete recomendado.
      </p>
      <div class="action-panel-cta">
        <a class="button-link" href="#activar">Activar implementacion</a>
        {% if founder and founder.whatsapp %}
        <a class="ghost" href="https://wa.me/{{ founder.whatsapp | replace('+','') | replace(' ','') }}?text=Quiero%20activar%20mi%20plan%20de%20automatizacion%20K%27an" target="_blank" rel="noopener">
          Hablar con un arquitecto
        </a>
        {% endif %}
      </div>
    </section>

    <section class="card">
      <h3>Impacto en ventas</h3>
      <p class="meta">
        Lo que podrias ganar si tu equipo estuviera libre: <strong>${{ output.roi_opportunity_mxn_per_month | round(0) }} MXN/mes</strong>.
        Con {{ jornadas_mes | round(1) }} jornadas liberadas al mes, tu gente vuelve a vender y atender clientes
        en lugar de capturar, ordenar y corregir.
      </p>
      <ul>
        <li><strong>Escalabilidad:</strong> esa carga manual equivale a {{ output.roi_fte_equivalent }} personas. Sin automatizar, para crecer vas a contratar mas.</li>
        <li><strong>Costo de rotacion:</strong> cada vez que entra alguien nuevo, reentrenarlo te puede costar aprox. ${{ output.roi_rotation_cost_mxn_per_hire | round(0) }} MXN.</li>
      </ul>
    </section>

    <section class="card">
      <h3>Dinero que estas dejando en la mesa</h3>
      <ul class="pain-list">
        {% for item in output.friction_points %}
        <li>{{ item }}</li>
        {% endfor %}
      </ul>
    </section>

    <section class="card">
      <h3>Que implementariamos primero</h3>
      <p class="meta">
        Esto es una infraestructura de automatizacion total: un <strong>Empleado Digital Invisible</strong> que trabaja 24/7
        en tus archivos, documentos y procesos (sin errores de copiar/pegar).
      </p>
      <div class="modules">
        {% for module in output.recommended_modules %}
        <div class="module">
          <h4>{{ module.name }}</h4>
          <p>{{ module.description }}</p>
          <p class="meta">Esfuerzo {{ module.effort }} · Impacto {{ module.impact }}/5 · {{ module.estimated_weeks }} semanas</p>
          <p class="tags">Integraciones: {{ module.integrations | join(", ") }}</p>
        </div>
        {% endfor %}
      </div>
    </section>

    {% if output.optional_modules %}
    <section class="card">
      <h3>Opciones adicionales (si aplica)</h3>
      <div class="modules">
        {% for module in output.optional_modules %}
        <div class="module">
          <h4>{{ module.name }}</h4>
          <p>{{ module.description }}</p>
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <section class="report-grid">
      <article class="card">
        <h3>Plan sugerido</h3>
        <ol class="roadmap">
          {% for phase in output.roadmap %}
          <li>
            <strong>{{ phase.name }}</strong>
            <span>{{ phase.focus }} · {{ phase.duration_label if phase.duration_label else phase.duration_weeks ~ " semanas" }}</span>
            <em>{{ phase.deliverable }}</em>
          </li>
          {% endfor %}
        </ol>
      </article>
      <article class="card">
        <h3>Perfil del equipo</h3>
        <div class="kpi">
          <span>Equipo actual</span>
          <strong>{{ payload.team_size }}</strong>
        </div>
        {% if payload.team_size_target %}
        <div class="kpi">
          <span>Equipo objetivo</span>
          <strong>{{ payload.team_size_target }}</strong>
        </div>
        {% endif %}
        <p class="meta">Actividad principal: {{ payload.business_focus }}</p>
        {% if payload.team_focus_same is not none %}
        <p class="meta">Equipo {{ "en una sola area" if payload.team_focus_same else "mixto" }}.</p>
        {% endif %}
        {% if payload.team_roles %}
        <p class="meta">Roles: {{ payload.team_roles }}</p>
        {% endif %}
      </article>
      <article class="card">
        <h3>Inversion clara</h3>
        <p class="meta">Explicado facil: es una inversion unica para automatizar lo que marcaste.</p>
        <div class="kpi">
          <span>Inversion unica (MXN)</span>
          <strong>${{ output.pricing.setup_fee_mxn }}</strong>
        </div>
        {% if output.pricing.roi_annual_formula_mxn is not none %}
        <div class="kpi">
          <span>ROI anual (formula Horas_Ahorradas x Costo_Hora - Inversion)</span>
          <strong>${{ output.pricing.roi_annual_net_mxn | round(0) }} MXN</strong>
        </div>
        {% endif %}
        {% if output.pricing.roi_multiple is not none %}
        <div class="kpi">
          <span>Multiplo anual ahorro / inversion</span>
          <strong>{{ output.pricing.roi_multiple }}x</strong>
        </div>
        {% endif %}
        {% if output.pricing.roi_adjusted_to_3x %}
        <p class="meta"><strong>Precio ajustado automaticamente para mantener oferta irresistible (ROI >= 3x).</strong></p>
        {% endif %}
        <div class="kpi">
          <span>Ahorro por errores evitados (estimado)</span>
          <strong>${{ output.roi_error_savings_mxn_per_month | round(0) }} MXN/mes</strong>
        </div>
        <div class="kpi">
          <span>Ahorro por tiempo (sueldos regalados)</span>
          <strong>${{ output.roi_time_value_mxn_per_month | round(0) }} MXN/mes</strong>
        </div>
        <div class="kpi">
          <span>Potencial extra en ventas (oportunidad)</span>
          <strong>${{ output.roi_opportunity_mxn_per_month | round(0) }} MXN/mes</strong>
        </div>
        <p class="meta">
          La configuracion tecnica y conexion de cuentas esta incluida y la hace nuestro equipo de ingenieros.
        </p>
        <ul>
          {% for item in output.pricing.assumptions %}
          <li>{{ item }}</li>
          {% endfor %}
        </ul>
      </article>
    </section>

    <section class="card">
      <h3>Resumen claro</h3>
      <p>{{ output.notes }}</p>
      {% if output.opportunities %}
      <h4>Oportunidades aplicables</h4>
      <ul>
        {% for item in output.opportunities %}
        <li>{{ item }}</li>
        {% endfor %}
      </ul>
      {% endif %}
      {% if output.limitations %}
      <h4>Limitaciones del rubro</h4>
      <ul>
        {% for item in output.limitations %}
        <li>{{ item }}</li>
        {% endfor %}
      </ul>
      {% endif %}
      {% if output.data_needed %}
      <h4>Datos que necesitamos</h4>
      <ul>
        {% for item in output.data_needed %}
        <li>{{ item }}</li>
        {% endfor %}
      </ul>
      {% endif %}
    </section>

    <section class="card cta" id="activar">
      <h3>Quieres que lo implementemos?</h3>
      <p class="meta">
        Paso final: agenda tu sesion de activacion. En esa llamada conectamos tus cuentas de forma segura por ti.
      </p>
      <form id="activationForm" method="post" action="/handoff">
        <input type="hidden" name="contact_email" value="{{ payload.contact_email or '' }}" />
        <input type="hidden" name="contact_whatsapp" value="{{ payload.contact_whatsapp or '' }}" />
        <input type="hidden" name="company_name" value="{{ payload.company_name }}" />
        <input type="hidden" name="industry" value="{{ payload.industry }}" />
        <input type="hidden" name="business_focus" value="{{ payload.business_focus }}" />
        <input type="hidden" name="region" value="{{ payload.region }}" />
        <input type="hidden" name="employee_band" value="{{ payload.employee_band or '' }}" />
        <input type="hidden" name="transaction_volume" value="{{ payload.transaction_volume or '' }}" />
        <input type="hidden" name="tooling_level" value="{{ payload.tooling_level or '' }}" />
        <input type="hidden" name="team_size" value="{{ payload.team_size }}" />
        <input type="hidden" name="team_roles" value="{{ payload.team_roles or '' }}" />
        <input type="hidden" name="manual_hours_per_week" value="{{ payload.manual_hours_per_week }}" />
        {% for module_key in payload.selected_modules %}
          <input type="hidden" class="base-selected-module" name="selected_modules" value="{{ module_key }}" />
        {% endfor %}
        <div id="expressModuleOverrides"></div>
        <input type="hidden" name="processes" value="{{ payload.processes or '' }}" />
        <input type="hidden" name="bottlenecks" value="{{ payload.bottlenecks }}" />
        <input type="hidden" name="systems" value="{{ payload.systems or '' }}" />
        <input type="hidden" name="goals" value="{{ payload.goals or '' }}" />
        <input type="hidden" name="budget_range" value="{{ payload.budget_range or '' }}" />
        <button type="submit">Pagar e iniciar conexion segura</button>
      </form>
    </section>

    <section class="card express-section" id="express-final">
      <h3>Soluciones express (micro y personal)</h3>
      <p class="meta">
        Estas opciones estan al final para que primero veas el analisis completo. Si das clic en una, te llevamos a implementacion y pago.
      </p>
      <div class="report-grid express-grid">
        <article
          class="card money solution express-trigger"
          role="button"
          tabindex="0"
          data-offer="chatbot"
          data-title="Chatbot basico para WhatsApp"
          data-price="$2,000 - $3,000 MXN"
          data-desc="Respuestas rapidas, FAQ basico y captura de datos de contacto para no perder mensajes."
        >
          <h3>Chatbot basico para WhatsApp</h3>
          <p class="money-amount">$2,000 - $3,000 MXN</p>
          <p class="meta">
            Respuestas rapidas, FAQ basico y captura de datos de contacto para no perder mensajes.
          </p>
        </article>
        <article
          class="card money solution express-trigger"
          role="button"
          tabindex="0"
          data-offer="agenda"
          data-title="Agenda + chatbot por WhatsApp"
          data-price="$2,500 - $4,500 MXN"
          data-desc="Confirmacion de citas, recordatorios automaticos y control simple de disponibilidad."
        >
          <h3>Agenda + chatbot por WhatsApp</h3>
          <p class="money-amount">$2,500 - $4,500 MXN</p>
          <p class="meta">
            Confirmacion de citas, recordatorios automaticos y control simple de disponibilidad.
          </p>
        </article>
      </div>
      {% if founder and founder.whatsapp %}
      <p class="meta">
        <a class="button-link" href="https://wa.me/{{ founder.whatsapp | replace('+','') | replace(' ','') }}?text=Quiero%20una%20solucion%20express%20de%20chatbot%20o%20agenda%20por%20WhatsApp" target="_blank" rel="noopener">
          Quiero solucion express por WhatsApp
        </a>
      </p>
      {% endif %}
    </section>

    <footer class="site-footer">
      <span>© 2026 K'an Logic Systems</span>
      <span class="footer-links">
        <a href="/privacy">Privacidad</a>
        <a href="/terms">Terminos</a>
        <a href="/contact">Contacto</a>
        <a href="/about">Nosotros</a>
        <a href="/data-deletion">Eliminacion de datos</a>
      </span>
    </footer>
  </main>

  <div class="modal-backdrop" id="expressModal" hidden>
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="expressModalTitle">
      <button type="button" class="modal-close" aria-label="Cerrar">x</button>
      <p class="pill mini">Implementacion express</p>
      <h3 id="expressModalTitle">Solucion express</h3>
      <p class="money-amount" id="expressModalPrice">$0 MXN</p>
      <p class="meta" id="expressModalDesc"></p>
      <div class="modal-actions">
        <button type="button" class="ghost-btn js-go-activar">Ver implementacion</button>
        <button type="button" class="button-link js-go-pay">Ir a implementacion y pago</button>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const modal = document.getElementById("expressModal");
      const titleEl = document.getElementById("expressModalTitle");
      const priceEl = document.getElementById("expressModalPrice");
      const descEl = document.getElementById("expressModalDesc");
      const closeBtn = modal ? modal.querySelector(".modal-close") : null;
      const goPayBtn = modal ? modal.querySelector(".js-go-pay") : null;
      const goActivarBtn = modal ? modal.querySelector(".js-go-activar") : null;
      const triggers = Array.from(document.querySelectorAll(".express-trigger"));
      const activationForm = document.getElementById("activationForm");
      const baseModules = activationForm
        ? Array.from(activationForm.querySelectorAll(".base-selected-module"))
        : [];
      const overrides = document.getElementById("expressModuleOverrides");
      let currentOffer = "";

      const offerModules = {
        chatbot: ["whatsapp_ventas"],
        agenda: ["whatsapp_ventas", "eficiencia_administrativa"],
      };

      function setOfferModules(offer) {
        if (!activationForm || !overrides) return;
        baseModules.forEach((input) => {
          input.disabled = true;
        });
        overrides.innerHTML = "";
        (offerModules[offer] || []).forEach((moduleKey) => {
          const hidden = document.createElement("input");
          hidden.type = "hidden";
          hidden.name = "selected_modules";
          hidden.value = moduleKey;
          overrides.appendChild(hidden);
        });
      }

      function closeModal() {
        if (!modal) return;
        modal.hidden = true;
      }

      function openModal(trigger) {
        if (!modal || !titleEl || !priceEl || !descEl) return;
        currentOffer = trigger.dataset.offer || "";
        titleEl.textContent = trigger.dataset.title || "Solucion express";
        priceEl.textContent = trigger.dataset.price || "";
        descEl.textContent = trigger.dataset.desc || "";
        modal.hidden = false;
      }

      triggers.forEach((trigger) => {
        trigger.addEventListener("click", () => openModal(trigger));
        trigger.addEventListener("keydown", (event) => {
          if (event.key === "Enter" || event.key === " ") {
            event.preventDefault();
            openModal(trigger);
          }
        });
      });

      if (closeBtn) {
        closeBtn.addEventListener("click", closeModal);
      }
      if (modal) {
        modal.addEventListener("click", (event) => {
          if (event.target === modal) {
            closeModal();
          }
        });
      }
      if (goActivarBtn) {
        goActivarBtn.addEventListener("click", () => {
          closeModal();
          const activar = document.getElementById("activar");
          if (activar) {
            activar.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        });
      }
      if (goPayBtn) {
        goPayBtn.addEventListener("click", () => {
          if (!activationForm) return;
          setOfferModules(currentOffer);
          activationForm.submit();
        });
      }
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          closeModal();
        }
      });
    })();
  </script>
</body>
</html>
