<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>K'an Logic Systems | Diagnostico IA</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <main class="page">
    <header class="site-nav">
      <a class="brand-link" href="/">
        <span class="brand-mark">
          <img src="/static/kan-logo.svg" alt="Logo K'an" />
        </span>
        <span class="brand-copy">
          <strong>K'an Logic Systems</strong>
          <small>Arquitectura IA para negocio real</small>
        </span>
      </a>
      <div class="site-nav-actions">
        <a class="ghost" href="/about">Nosotros</a>
        <a class="ghost" href="/contact">Contacto</a>
        <a class="ghost" href="/arquitecto">Sobre el Arquitecto</a>
        <button type="button" class="mini-btn js-check-ai">Verificar API IA</button>
        <span class="mini-note js-ai-status">IA sin verificar</span>
        <a class="button-link" href="#diagnostico">Iniciar Auditoria</a>
      </div>
    </header>

    <section class="hero">
      <div class="hero-content hero-content-main">
        <p class="pill">K'an Logic Systems</p>
        <h1>Tu WhatsApp puede responder solo en 72 horas.</h1>
        <p class="lead">
          Si quieres algo rapido, te activamos chatbot o agenda sin consultoria larga.
          Si quieres transformacion completa, te llevamos por auditoria y roadmap.
        </p>
        <div class="hero-actions">
          <a class="button-link" href="#quick-order">Quiero solucion rapida</a>
          <a class="ghost" href="#diagnostico">Quiero auditoria completa</a>
        </div>
        <div class="hero-grid">
          <div class="hero-card">
            <h3>Resultado concreto</h3>
            <p>WhatsApp respondiendo, leads capturados y citas confirmadas automaticamente.</p>
          </div>
          <div class="hero-card">
            <h3>Activacion rapida</h3>
            <p>Implementacion express en 72 horas con sesion guiada y 1 ajuste incluido.</p>
          </div>
          <div class="hero-card">
            <h3>Escalable por modulos</h3>
            <p>Empiezas con algo simple y luego agregas inventario, reportes y automatizacion avanzada.</p>
          </div>
        </div>
      </div>
      <aside class="hero-tech-panel">
        <div class="hero-logo-frame">
          <img src="/static/kan-logo.svg" alt="Logo K'an principal" />
        </div>
        <div class="hero-metric">
          <span>Implementacion inicial</span>
          <strong>72h - 14 dias</strong>
        </div>
        <div class="hero-metric">
          <span>Solucion express</span>
          <strong>$2,000 MXN+</strong>
        </div>
      </aside>
    </section>

    <section class="trust-strip">
      <p class="trust-title">Trabajamos con:</p>
      <div class="trust-logos">
        {% for item in trust %}
          <span class="trust-chip">{{ item }}</span>
        {% endfor %}
      </div>
      <a class="mini-btn" href="/about">Nosotros</a>
    </section>

    <section class="card route-pick" id="opciones">
      <div class="section-title">
        <h2>Elige tu ruta</h2>
        <p>No todos ocupan lo mismo: micro-negocio express o transformacion completa.</p>
      </div>
      <div class="route-grid">
        <article class="route-card">
          <p class="pill mini">Mundo 1 · Express</p>
          <h3>Quiero algo funcionando ya</h3>
          <p class="meta">Ideal para tienda, clinica o despacho que quiere ahorrar tiempo hoy.</p>
          <ul class="ops-list">
            <li>Precio fijo.</li>
            <li>Activacion en 72 horas.</li>
            <li>Sin tecnicismos.</li>
          </ul>
          <a class="button-link" href="#quick-order">Ir a Express</a>
        </article>
        <article class="route-card">
          <p class="pill mini">Mundo 2 · Arquitectura</p>
          <h3>Quiero transformar mi operacion</h3>
          <p class="meta">Para empresas que necesitan roadmap, integraciones y escalamiento por fases.</p>
          <ul class="ops-list">
            <li>Auditoria con ROI.</li>
            <li>Roadmap por etapas.</li>
            <li>Integraciones complejas.</li>
          </ul>
          <a class="ghost" href="#diagnostico">Ir a auditoria</a>
        </article>
      </div>
    </section>

    <section class="quick-order card" id="quick-order">
      <div class="section-title">
        <h2>Compra express (activacion inmediata)</h2>
        <p>
          Si hoy solo quieres algo puntual, activamos rapido.
          Sin cotizacion larga ni proceso pesado.
        </p>
      </div>

      <div class="quick-offer-grid">
        <article class="quick-offer-card active" data-offer="chatbot_whatsapp" aria-selected="true">
          <p class="pill mini">Express</p>
          <h3>Chatbot basico para WhatsApp</h3>
          <ul class="deliverable-list">
            <li>Respuestas FAQ automaticas.</li>
            <li>Captura de leads por WhatsApp.</li>
            <li>Mensaje fuera de horario.</li>
            <li>1 ajuste incluido.</li>
          </ul>
          <strong>Desde $2,000 MXN</strong>
        </article>
        <article class="quick-offer-card" data-offer="agenda_chatbot" aria-selected="false">
          <p class="pill mini">Express</p>
          <h3>Agenda + chatbot por WhatsApp</h3>
          <ul class="deliverable-list">
            <li>Confirmacion automatica de citas.</li>
            <li>Recordatorio 24h antes.</li>
            <li>Reagendado basico por chat.</li>
            <li>1 ajuste incluido.</li>
          </ul>
          <strong>Desde $3,500 MXN</strong>
        </article>
      </div>

      <form class="quick-order-form" method="post" action="/quick-start">
        <div class="grid">
          <label>
            Solucion express
            <select name="quick_offer" required>
              <option value="chatbot_whatsapp" selected>Chatbot basico para WhatsApp (desde $2,000)</option>
              <option value="agenda_chatbot">Agenda + chatbot por WhatsApp (desde $3,500)</option>
            </select>
          </label>
          <label>
            Nombre del negocio
            <input type="text" name="company_name" placeholder="Ej. Tienda La Esquina" required />
          </label>
          <label>
            Correo de contacto
            <input type="email" name="contact_email" placeholder="tu@empresa.com" required />
          </label>
          <label>
            WhatsApp (opcional)
            <input type="text" name="contact_whatsapp" placeholder="Ej. +52 55 1234 5678" />
          </label>
        </div>

        <label class="consent">
          <input type="checkbox" name="consent_contact" required />
          <span>Acepto recibir contacto para activar esta solucion express.</span>
        </label>

        <div class="quick-order-actions">
          <button type="submit">Activar solucion express</button>
          <a class="ghost" href="#diagnostico">Prefiero auditoria completa</a>
        </div>
      </form>

      <article class="market-compare">
        <p class="pill mini">Comparativa de mercado</p>
        <h3>Competencia sana: mismo objetivo, entrada mas accesible</h3>
        <p class="meta">
          Referencia publica consultada: en la landing de LeadSales se muestra plan Basic en <strong>$2,362.92 MXN/mes</strong>.
          K'an Express arranca por debajo para micro-negocios y activaciones puntuales.
        </p>
        <div class="compare-table" role="table" aria-label="Comparativa de soluciones">
          <div class="compare-row compare-head" role="row">
            <span role="columnheader">Opcion</span>
            <span role="columnheader">Precio publicado</span>
            <span role="columnheader">Enfoque</span>
          </div>
          <div class="compare-row" role="row">
            <span role="cell">LeadSales Basic (referencia)</span>
            <span role="cell">$2,362.92 MXN/mes</span>
            <span role="cell">Plataforma de ventas por WhatsApp</span>
          </div>
          <div class="compare-row emphasize" role="row">
            <span role="cell">K'an Express Chatbot</span>
            <span role="cell">Desde $2,000 MXN</span>
            <span role="cell">Respuestas FAQ + captura de leads + fuera de horario</span>
          </div>
          <div class="compare-row emphasize" role="row">
            <span role="cell">K'an Express Agenda + Chatbot</span>
            <span role="cell">Desde $3,500 MXN</span>
            <span role="cell">Confirmacion de citas + recordatorios + reagendado</span>
          </div>
        </div>
        <p class="meta">
          Nota: precios de terceros pueden cambiar sin aviso. Nosotros mantenemos esta entrada competitiva y clara.
        </p>
      </article>
    </section>

    <section class="card post-pay-flow">
      <h3>Que pasa despues de pagar</h3>
      <div class="flow-steps">
        <article class="flow-step">
          <strong>1) Pago confirmado</strong>
          <p>Recibes confirmacion por correo y WhatsApp.</p>
        </article>
        <article class="flow-step">
          <strong>2) Contacto del equipo</strong>
          <p>Te escribimos para coordinar la sesion de activacion (15-30 min).</p>
        </article>
        <article class="flow-step">
          <strong>3) Sesion guiada</strong>
          <p>Conectamos cuentas en pantalla, sin pedirte tecnicismos por chat.</p>
        </article>
        <article class="flow-step">
          <strong>4) Activacion</strong>
          <p>Publicamos el flujo y hacemos pruebas contigo.</p>
        </article>
        <article class="flow-step">
          <strong>5) Uso diario</strong>
          <p>Empiezas a operar y medimos resultados desde la primera semana.</p>
        </article>
      </div>
    </section>

    <section class="report-grid case-grid">
      <article class="card money problem">
        <h3>Antes (ejemplo tipo tienda)</h3>
        <ul class="pain-list">
          <li>40 mensajes sin responder cada dia.</li>
          <li>2 horas diarias contestando lo mismo.</li>
          <li>Citas y prospectos perdidos por falta de seguimiento.</li>
        </ul>
      </article>
      <article class="card money solution">
        <h3>Despues (primeras semanas)</h3>
        <ul class="pain-list">
          <li>0 mensajes perdidos fuera de horario.</li>
          <li>80% de respuestas automaticas en FAQ.</li>
          <li>Agenda confirmada y seguimiento en el mismo chat.</li>
        </ul>
      </article>
    </section>

    <section class="impact-ribbon">
      <article class="impact-item">
        <span>ROI esperado</span>
        <strong>3x a 8x</strong>
        <small>segun alcance y volumen</small>
      </article>
      <article class="impact-item">
        <span>Tiempo de despliegue</span>
        <strong>72h - 14 dias</strong>
        <small>segun complejidad</small>
      </article>
      <article class="impact-item">
        <span>Modelo de precio</span>
        <strong>Micro a Enterprise</strong>
        <small>sin sobre-cotizar</small>
      </article>
      <article class="impact-item">
        <span>Canales</span>
        <strong>WhatsApp + Datos + CRM</strong>
        <small>listo para operar</small>
      </article>
    </section>

    <section class="ops-grid">
      <article class="card ops-card">
        <p class="pill mini">Implementacion clara</p>
        <h3>Asi construimos sin complicarte la operacion</h3>
        <div class="ops-steps">
          <div class="ops-step">
            <b>01 Descubrimos el cuello de botella</b>
            <p>Detectamos donde se te va tiempo o ventas y priorizamos lo primero a resolver.</p>
          </div>
          <div class="ops-step">
            <b>02 Activamos el flujo</b>
            <p>Conectamos WhatsApp/sistemas y dejamos automatizacion funcionando en produccion.</p>
          </div>
          <div class="ops-step">
            <b>03 Escalamos por modulos</b>
            <p>Cuando ya funciona lo basico, agregamos inventario, reportes y mas automatizaciones.</p>
          </div>
        </div>
      </article>
      <article class="card ops-card compact">
        <p class="pill mini">Que recibes exactamente</p>
        <h3>Entregables por tipo de servicio</h3>
        <ul class="ops-list">
          <li><strong>Express:</strong> chatbot/agenda activos + 1 ajuste + handoff.</li>
          <li><strong>Auditoria:</strong> diagnostico + plan por fases + propuesta economica.</li>
          <li><strong>Arquitectura:</strong> integraciones, seguridad y escalamiento modular.</li>
        </ul>
        <a class="button-link" href="#quick-order">Quiero activar Express</a>
      </article>
    </section>

    <section class="card">
      <h3>Portal del cliente</h3>
      <p class="meta">
        Si ya confirmaste tu implementacion, entra con tu correo y contrasena para revisar estatus,
        entregables y accesos autorizados.
      </p>
      <a class="button-link" href="/portal">Entrar al portal</a>
    </section>

    <section class="form-section" id="diagnostico">
      <div class="section-title">
        <h2>Inicia tu auditoria IA</h2>
        <p>Primero guardamos tu contacto. Luego estimamos tu ganancia anual con IA.</p>
      </div>
      <form class="diagnostic-form" method="post" action="/diagnose">
        <div class="stepper" data-steps="4">
          <div class="stepper-header">
            <div>
              <p class="pill mini">Diagnostico express</p>
              <h3>Te toma 90 segundos</h3>
            </div>
            <div class="mini-actions">
              <button type="button" class="mini-btn js-load-example">Cargar ejemplo</button>
              <span class="mini-note">Guardamos tu progreso</span>
              <div class="stepper-counter">
                Paso <span class="step-current">1</span> de <span class="step-total">4</span>
              </div>
            </div>
          </div>
          <div class="stepper-track">
            <div class="stepper-progress"></div>
          </div>
          <div class="stepper-labels">
            <span class="step-label active">Contacto</span>
            <span class="step-label">Negocio</span>
            <span class="step-label">Prioridades</span>
            <span class="step-label">Numeros</span>
          </div>
        </div>

        <section class="form-step active" data-step="1">
          <h4>Paso cero: guardamos tu contacto</h4>
          <p class="meta">
            Asi, si te sales a la mitad, no perdemos el avance y te podemos enviar el diagnostico.
          </p>
          <div class="grid">
            <label>
              ¿A que correo te enviamos tu diagnostico?
              <input type="email" name="contact_email" placeholder="tu@empresa.com" required />
            </label>
            <label>
              WhatsApp (opcional)
              <input type="text" name="contact_whatsapp" placeholder="Ej. +52 55 1234 5678" />
            </label>
          </div>
          <label class="consent">
            <input type="checkbox" name="consent_contact" required />
            <span>Acepto recibir mi diagnostico en este correo y que me contacten para coordinar la implementacion (si aplica).</span>
          </label>
          <input type="hidden" name="capture_id" value="" />
        </section>

        <section class="form-step" data-step="2">
          <h4>Perfil del negocio</h4>
          <div class="grid">
            <label>
              Empresa
              <input type="text" name="company_name" placeholder="Ej. Textiles Orion" required />
            </label>
            <label>
              Industria
              <input type="text" name="industry" placeholder="Ej. Retail, Logistica" required />
            </label>
            <label>
              A que se dedica
              <input type="text" name="business_focus" placeholder="Ej. Consultorio dental, restaurante, taller mecanico" required />
            </label>
            <label>
              Filtro de escala: numero de empleados
              <select name="employee_band" required>
                <option value="">Selecciona</option>
                <option value="1-5">1-5</option>
                <option value="6-20">6-20</option>
                <option value="21-100+">21-100+</option>
              </select>
            </label>
            <label>
              Volumen de transacciones/mensajes
              <select name="transaction_volume" required>
                <option value="">Selecciona</option>
                <option value="bajo">Bajo</option>
                <option value="medio">Medio</option>
                <option value="alto">Alto</option>
              </select>
            </label>
            <label>
              Herramienta principal en uso
              <select name="tooling_level" required>
                <option value="">Selecciona</option>
                <option value="solo_whatsapp">Solo WhatsApp</option>
                <option value="excel">Excel/Sheets</option>
                <option value="shopify">Shopify/eCommerce</option>
                <option value="erp_complejo">ERP complejo</option>
              </select>
            </label>
            <label>
              Region
              <select name="region" required>
                <option value="">Selecciona tu pais</option>
                <optgroup label="Norteamerica">
                  <option value="Canada">Canada</option>
                  <option value="Estados Unidos">Estados Unidos</option>
                  <option value="Mexico" selected>Mexico</option>
                </optgroup>
                <optgroup label="Centroamerica">
                  <option value="Belice">Belice</option>
                  <option value="Guatemala">Guatemala</option>
                  <option value="Honduras">Honduras</option>
                  <option value="El Salvador">El Salvador</option>
                  <option value="Nicaragua">Nicaragua</option>
                  <option value="Costa Rica">Costa Rica</option>
                  <option value="Panama">Panama</option>
                </optgroup>
                <optgroup label="Caribe">
                  <option value="Antigua y Barbuda">Antigua y Barbuda</option>
                  <option value="Bahamas">Bahamas</option>
                  <option value="Barbados">Barbados</option>
                  <option value="Cuba">Cuba</option>
                  <option value="Dominica">Dominica</option>
                  <option value="Republica Dominicana">Republica Dominicana</option>
                  <option value="Granada">Granada</option>
                  <option value="Haiti">Haiti</option>
                  <option value="Jamaica">Jamaica</option>
                  <option value="San Cristobal y Nieves">San Cristobal y Nieves</option>
                  <option value="Santa Lucia">Santa Lucia</option>
                  <option value="San Vicente y las Granadinas">San Vicente y las Granadinas</option>
                  <option value="Trinidad y Tobago">Trinidad y Tobago</option>
                </optgroup>
                <optgroup label="Sudamerica">
                  <option value="Argentina">Argentina</option>
                  <option value="Bolivia">Bolivia</option>
                  <option value="Brasil">Brasil</option>
                  <option value="Chile">Chile</option>
                  <option value="Colombia">Colombia</option>
                  <option value="Ecuador">Ecuador</option>
                  <option value="Guyana">Guyana</option>
                  <option value="Paraguay">Paraguay</option>
                  <option value="Peru">Peru</option>
                  <option value="Surinam">Surinam</option>
                  <option value="Uruguay">Uruguay</option>
                  <option value="Venezuela">Venezuela</option>
                </optgroup>
              </select>
            </label>
          </div>
        </section>

        <section class="form-step" data-step="3">
          <h4>Prioridades (elige lo que mas te urge)</h4>
          <p class="meta">No te preocupes por la tecnologia: nosotros conectamos tus cuentas en una sesion guiada.</p>
          <div class="module-grid">
            <label class="module-choice">
              <input type="checkbox" name="selected_modules" value="whatsapp_ventas" />
              <span>WhatsApp / Ventas</span>
              <small>Responde, califica leads, cotiza y agenda automaticamente.</small>
            </label>
            <label class="module-choice">
              <input type="checkbox" name="selected_modules" value="inventarios_datos" />
              <span>Inventarios / Datos</span>
              <small>Actualiza stock, evita quiebres y elimina capturas manuales.</small>
            </label>
            <label class="module-choice">
              <input type="checkbox" name="selected_modules" value="dashboards_reportes" />
              <span>Dashboards / Reportes</span>
              <small>Visibilidad diaria: ventas, inventario, operaciones y alertas.</small>
            </label>
            <label class="module-choice">
              <input type="checkbox" name="selected_modules" value="eficiencia_administrativa" />
              <span>Eficiencia administrativa</span>
              <small>Carpetas, archivos, organizacion y flujos documentales (0 caos).</small>
            </label>
            <label class="module-choice">
              <input type="checkbox" name="selected_modules" value="documentos_inteligentes" />
              <span>Documentos inteligentes (PDF)</span>
              <small>Contratos, cotizaciones, recibos y facturas automaticas.</small>
            </label>
            <label class="module-choice">
              <input type="checkbox" name="selected_modules" value="conciliacion_automatica" />
              <span>Conciliacion automatica</span>
              <small>Compara banco, ventas y hojas para detectar errores sin retrabajo.</small>
            </label>
          </div>
          <label>
            ¿Que tareas te quitan mas tiempo hoy?
            <textarea name="bottlenecks" rows="3" placeholder="Ej. Responder mensajes, hacer cotizaciones, capturar pedidos, actualizar inventario, facturar, reportes..." required></textarea>
          </label>
          <label>
            Si quieres, describe tu operacion (opcional)
            <textarea name="processes" rows="2" placeholder="Ej. ventas, inventario, compras, envios, soporte"></textarea>
          </label>
          <label>
            Herramientas que usas (opcional)
            <textarea name="systems" rows="2" placeholder="Ej. Excel, WhatsApp, Shopify, Odoo, Google Sheets"></textarea>
          </label>
          <label>
            Objetivo principal (opcional)
            <textarea name="goals" rows="2" placeholder="Ej. Vender mas, reducir errores, responder mas rapido"></textarea>
          </label>
        </section>

        <section class="form-step" data-step="4">
          <h4>Numeros rapidos (para calcular tu ganancia anual)</h4>
          <div class="grid">
            <label>
              Tamano del equipo actual
              <input type="number" name="team_size" min="1" placeholder="10" required />
            </label>
            <label>
              Horas a la semana en tareas manuales (aprox.)
              <input type="number" name="manual_hours_per_week" min="0" step="1" placeholder="12" required />
            </label>
          </div>
          <div class="preview-grid" aria-live="polite">
            <div class="preview-card problem">
              <span>Costo anual de tu ineficiencia</span>
              <strong id="previewAnnual">$0 MXN</strong>
              <small>Incluye sueldos + errores + costo de oportunidad (estimado).</small>
            </div>
            <div class="preview-card solution">
              <span>Inversion estimada K'an (base + extras)</span>
              <strong id="previewPrice">$0 MXN</strong>
              <small id="previewTier">Se confirma en la sesion de Activacion.</small>
            </div>
          </div>
          <p class="meta" id="previewPayback"></p>
          <label>
            Areas o roles del equipo (opcional)
            <textarea name="team_roles" rows="2" placeholder="Ej. 4 ventas, 3 admin, 2 soporte, 1 operaciones"></textarea>
          </label>
          <div class="grid">
            <label>
              Rango de presupuesto (opcional, MXN)
              <input type="text" name="budget_range" placeholder="$10,000 - $80,000 MXN" />
            </label>
          </div>
        </section>

        <div class="step-actions">
          <button type="button" class="ghost-btn step-prev">Atras</button>
          <button type="button" class="step-next">Siguiente</button>
          <button type="submit" class="step-submit">Generar auditoria IA</button>
        </div>
      </form>
    </section>

    <footer class="site-footer">
      <span>© 2026 K'an Logic Systems</span>
      <span class="footer-links">
        <a href="/privacy">Privacidad</a>
        <a href="/terms">Terminos</a>
        <a href="/contact">Contacto</a>
        <a href="/about">Nosotros</a>
        <a href="/data-deletion">Eliminacion de datos</a>
      </span>
    </footer>
  </main>
  <script>
    const quickOfferSelect = document.querySelector('select[name="quick_offer"]');
    const quickOfferCards = Array.from(document.querySelectorAll(".quick-offer-card"));
    const quickOfferTriggers = Array.from(document.querySelectorAll("[data-quick-offer]"));

    const setQuickOffer = (offer) => {
      if (!quickOfferSelect) return;
      const selected = offer === "agenda_chatbot" ? "agenda_chatbot" : "chatbot_whatsapp";
      quickOfferSelect.value = selected;
      quickOfferCards.forEach((card) => {
        const active = card.dataset.offer === selected;
        card.classList.toggle("active", active);
        card.setAttribute("aria-selected", active ? "true" : "false");
      });
    };

    if (quickOfferSelect) {
      quickOfferTriggers.forEach((trigger) => {
        trigger.addEventListener("click", () => {
          setQuickOffer(trigger.dataset.quickOffer || "chatbot_whatsapp");
        });
      });
      quickOfferCards.forEach((card) => {
        card.addEventListener("click", () => {
          setQuickOffer(card.dataset.offer || "chatbot_whatsapp");
          quickOfferSelect.focus();
        });
      });
      quickOfferSelect.addEventListener("change", () => {
        setQuickOffer(quickOfferSelect.value);
      });
      setQuickOffer(quickOfferSelect.value || "chatbot_whatsapp");
    }

    const form = document.querySelector(".diagnostic-form");
    if (form) {
      const steps = Array.from(form.querySelectorAll(".form-step"));
      const labels = Array.from(form.querySelectorAll(".step-label"));
      const progress = form.querySelector(".stepper-progress");
      const currentEl = form.querySelector(".step-current");
      const totalEl = form.querySelector(".step-total");
      const prevBtn = form.querySelector(".step-prev");
      const nextBtn = form.querySelector(".step-next");
      const submitBtn = form.querySelector(".step-submit");
      const exampleBtn = form.querySelector(".js-load-example");
      const captureIdField = form.querySelector("input[name='capture_id']");
      const emailField = form.querySelector("input[name='contact_email']");
      const phoneField = form.querySelector("input[name='contact_whatsapp']");
      const consentField = form.querySelector("input[name='consent_contact']");
      const teamSizeField = form.querySelector("input[name='team_size']");
      const employeeBandField = form.querySelector("select[name='employee_band']");
      const transactionVolumeField = form.querySelector("select[name='transaction_volume']");
      const toolingLevelField = form.querySelector("select[name='tooling_level']");
      const manualHoursField = form.querySelector("input[name='manual_hours_per_week']");
      const bottlenecksField = form.querySelector("textarea[name='bottlenecks']");
      const previewAnnual = document.getElementById("previewAnnual");
      const previewPrice = document.getElementById("previewPrice");
      const previewTier = document.getElementById("previewTier");
      const previewPayback = document.getElementById("previewPayback");
      const aiCheckBtn = document.querySelector(".js-check-ai");
      const aiStatus = document.querySelector(".js-ai-status");
      const fields = Array.from(form.querySelectorAll("input, textarea, select"));
      fields.forEach((field) => {
        if (field.required) {
          field.dataset.required = "1";
        }
      });
      const checkboxCounts = fields.reduce((acc, field) => {
        if (field.type !== "checkbox" || !field.name) return acc;
        acc[field.name] = (acc[field.name] || 0) + 1;
        return acc;
      }, {});

      const storageKey = "kan_diagnostic_v2";
      const persist = () => {
        const data = {};
        Object.keys(checkboxCounts).forEach((name) => {
          if (checkboxCounts[name] > 1) {
            data[name] = [];
          }
        });
        fields.forEach((field) => {
          if (!field.name) return;
          if (field.type === "password") return;
          if (field.type === "checkbox") {
            const isGroup = checkboxCounts[field.name] > 1;
            if (isGroup) {
              if (field.checked) {
                data[field.name].push(field.value);
              }
            } else {
              data[field.name] = field.checked ? "1" : "0";
            }
            return;
          }
          data[field.name] = field.value;
        });
        try {
          localStorage.setItem(storageKey, JSON.stringify(data));
        } catch (err) {
          // ignore (private mode / storage disabled)
        }
      };

      const restore = () => {
        try {
          const raw = localStorage.getItem(storageKey);
          if (!raw) return;
          const data = JSON.parse(raw);
          fields.forEach((field) => {
            if (!field.name) return;
            if (field.type === "checkbox") {
              const stored = data[field.name];
              if (Array.isArray(stored)) {
                field.checked = stored.includes(field.value);
              } else if (typeof stored === "string") {
                field.checked = stored === "1";
              }
              return;
            }
            if (typeof data[field.name] !== "string") return;
            field.value = data[field.name];
          });
        } catch (err) {
          // ignore
        }
      };

      const resolveEmployeeBand = (teamSize, employeeBand) => {
        if (employeeBand) return employeeBand;
        if (!teamSize || teamSize <= 5) return "1-5";
        if (teamSize <= 20) return "6-20";
        return "21-100+";
      };

      const selectServiceTier = (employeeBand, volume, tooling, painText, teamSize, moduleCount) => {
        const text = (painText || "").toLowerCase();
        const eliteKeywords = ["memoria", "scraping", "masivo", "trading", "erp"];
        const microKeywords = ["agenda", "citas", "recordatorio", "calendario", "personal"];
        if (tooling === "erp_complejo" || volume === "alto" || employeeBand === "21-100+" || eliteKeywords.some((k) => text.includes(k))) {
          return { name: "ELITE", min: 60000, max: 120000 };
        }
        if (employeeBand === "1-5" && (volume === "" || volume === "bajo") && (tooling === "" || tooling === "solo_whatsapp" || tooling === "excel") && (microKeywords.some((k) => text.includes(k)) || teamSize <= 2 || moduleCount <= 1)) {
          return { name: "MICRO", min: 2000, max: 3000 };
        }
        if (employeeBand === "1-5" && (volume === "" || volume === "bajo") && (tooling === "" || tooling === "solo_whatsapp" || tooling === "excel")) {
          return { name: "LITE", min: 8000, max: 12000 };
        }
        return { name: "GROWTH", min: 25000, max: 45000 };
      };

        const updatePreview = () => {
          if (!previewAnnual || !previewPrice || !previewPayback) return;
          const teamSize = Number(teamSizeField ? teamSizeField.value : 0) || 0;
          const employeeBand = resolveEmployeeBand(teamSize, employeeBandField ? employeeBandField.value : "");
          const transactionVolume = transactionVolumeField ? transactionVolumeField.value : "";
          const toolingLevel = toolingLevelField ? toolingLevelField.value : "";
          const hours = Number(manualHoursField ? manualHoursField.value : 0) || 0;
        const selected = Array.from(form.querySelectorAll('input[name="selected_modules"]'))
          .filter((input) => input.checked)
          .map((input) => input.value);
        const painText = (bottlenecksField ? bottlenecksField.value : "") || "";

          const moduleCount = selected.length;
          const tier = selectServiceTier(employeeBand, transactionVolume, toolingLevel, painText, teamSize, moduleCount);
          const toolingScore = { solo_whatsapp: 0, excel: 1, shopify: 2, erp_complejo: 3 }[toolingLevel] || 1;
          const volumeScore = { bajo: 0, medio: 1, alto: 2 }[transactionVolume] || 1;
          const addons = tier.name === "MICRO"
            ? (moduleCount * 500)
            : (moduleCount * 1500) + (toolingScore * 2000) + (volumeScore * 2500);
          let suggested = Math.round((tier.min + addons) / 500) * 500;
          suggested = Math.max(tier.min, Math.min(tier.max, suggested));

        const weeksPerMonth = 4.33;
        const workdaysPerMonth = 22;
        const hoursPerDay = 8;
        const netMonthlySalary = 10000;
        const benefitsRate = 0.30;
        const loadedMonthly = netMonthlySalary * (1 + benefitsRate);
        const loadedHourly = loadedMonthly / (workdaysPerMonth * hoursPerDay);

        const monthlyTime = (hours * weeksPerMonth) * loadedHourly;
        const raw = painText.toLowerCase();
        const adminKeywords = ["carpeta", "carpetas", "archivo", "archivos", "organizar", "papeleo", "documento", "documentos", "contrato", "firmar", "firma", "pdf"];
        const financeKeywords = ["banco", "conciliacion", "tesoreria", "contabilidad", "factura", "facturacion", "inventario", "stock"];
        const salesKeywords = ["ventas", "lead", "leads", "prospect", "prospecto", "whatsapp", "conversion", "cotizacion", "cotizar", "seguimiento", "clientes", "atencion", "responder", "soporte"];
        let factor = 0.15;
        if (selected.includes("eficiencia_administrativa") || selected.includes("documentos_inteligentes")) {
          factor = 0.35;
        } else if (selected.includes("conciliacion_automatica") || selected.includes("inventarios_datos")) {
          factor = 0.25;
        } else if (adminKeywords.some((k) => raw.includes(k))) {
          factor = 0.35;
        } else if (financeKeywords.some((k) => raw.includes(k))) {
          factor = 0.25;
        }
        const errorCost = monthlyTime * factor;
        const errorSavings = errorCost * 0.6;
        let oppFactor = 0.3;
        if (selected.includes("whatsapp_ventas")) {
          oppFactor = 0.8;
        } else if (salesKeywords.some((k) => raw.includes(k))) {
          oppFactor = 0.6;
        }
        const opportunity = monthlyTime * oppFactor;
        const totalMonthly = monthlyTime + errorSavings;
        const totalWithOpportunity = totalMonthly + opportunity;
        const annual = totalWithOpportunity * 12;
        const automationRatio = Math.min(0.6, 0.15 + (moduleCount * 0.1));
        const annualHoursSaved = hours * 52 * automationRatio;
        const annualFormulaSavings = annualHoursSaved * loadedHourly;
        const maxInvestment3x = annualFormulaSavings / 3;
        const adjusted = maxInvestment3x > 0 && suggested > maxInvestment3x;
        const price = adjusted
          ? Math.max(1000, Math.round(maxInvestment3x / 500) * 500)
          : suggested;
        const payback = totalMonthly > 0 ? price / totalMonthly : 0;

        const money = (value) =>
          `$${Math.round(value).toLocaleString("es-MX")} MXN`;

        previewAnnual.textContent = money(annual);
        previewPrice.textContent = money(price);
        if (previewTier) {
          previewTier.textContent = adjusted
            ? `Paquete ${tier.name} con ajuste ROI 3x para oferta irresistible.`
            : `Paquete ${tier.name}: rango ${money(tier.min)} - ${money(tier.max)}.`;
        }
        previewPayback.textContent =
          totalMonthly > 0
            ? `Payback conservador: ${payback.toFixed(1)} meses (sin contar oportunidad en ventas).`
            : "Tip: si no sabes, estima cuantas horas a la semana se van en tareas manuales (8h = 1 jornada).";
      };

      const loadExample = () => {
        const example = {
          contact_email: "dueño@tutienda.com",
          consent_contact: "1",
          company_name: "Tienda La Esquina",
          industry: "Retail",
          business_focus: "Venta de abarrotes y productos de consumo",
          region: "Mexico",
          employee_band: "6-20",
          transaction_volume: "medio",
          tooling_level: "excel",
          team_size: "8",
          team_roles: "4 ventas, 2 admin, 2 soporte",
          manual_hours_per_week: "14",
          selected_modules: "1",
          processes: "ventas, inventario, reportes",
          bottlenecks: "responder mensajes, capturar pedidos y actualizar inventario manualmente",
          systems: "Excel, WhatsApp, Punto de venta",
          goals: "responder mas rapido y vender mas",
          budget_range: "$10,000 - $60,000 MXN",
        };
        fields.forEach((field) => {
          if (!field.name) return;
          if (!(field.name in example)) return;
          if (field.type === "checkbox") {
            field.checked = example[field.name] === "1";
            return;
          }
          field.value = example[field.name];
        });
        const selected = Array.from(form.querySelectorAll('input[name="selected_modules"]'));
        selected.forEach((input) => {
          input.checked = ["whatsapp_ventas", "inventarios_datos", "eficiencia_administrativa"].includes(input.value);
        });
        persist();
        updatePreview();
      };

      const setAiStatus = (message, state) => {
        if (!aiStatus) return;
        aiStatus.textContent = message;
        aiStatus.classList.remove("ok", "error");
        if (state) {
          aiStatus.classList.add(state);
        }
      };

      const checkAiHealth = async () => {
        if (!aiCheckBtn) return;
        aiCheckBtn.disabled = true;
        setAiStatus("Verificando...", "");
        try {
          const response = await fetch("/api/health/ai", {
            headers: { Accept: "application/json" },
          });
          const data = await response.json();
          if (response.ok && data && data.ok) {
            const model = data.active_model || data.configured_model || "gemini";
            setAiStatus(`IA conectada (${model})`, "ok");
          } else {
            const detail = (data && (data.error || data.reply)) || "sin respuesta";
            setAiStatus(`Error IA: ${detail}`, "error");
          }
        } catch (err) {
          setAiStatus("Error IA: no se pudo verificar", "error");
        } finally {
          aiCheckBtn.disabled = false;
        }
      };

      let index = 0;
      const total = steps.length;
      if (totalEl) totalEl.textContent = String(total);

      let captureInFlight = false;
      let captureTimer = null;
      const captureLead = async () => {
        if (!emailField || !captureIdField) return;
        if (captureInFlight) return;
        if (captureIdField.value) return;
        if (!emailField.checkValidity()) return;
        captureInFlight = true;
        try {
          const body = new URLSearchParams();
          body.set("email", emailField.value);
          body.set("phone", phoneField ? phoneField.value : "");
          body.set("consent_contact", consentField && consentField.checked ? "1" : "0");
          body.set("source", window.location.href);

          const response = await fetch("/api/capture", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: body.toString(),
          });
          const data = await response.json();
          if (data && data.ok && data.capture_id) {
            captureIdField.value = String(data.capture_id);
            persist();
          }
        } catch (err) {
          // ignore network errors
        } finally {
          captureInFlight = false;
        }
      };

      const scheduleCapture = () => {
        if (captureTimer) clearTimeout(captureTimer);
        captureTimer = setTimeout(() => {
          captureLead();
        }, 450);
      };

      const updateRequired = () => {
        steps.forEach((step, idx) => {
          const active = idx === index;
          step.querySelectorAll("input, textarea, select").forEach((field) => {
            if (field.dataset.required === "1") {
              field.required = active;
            }
          });
        });
      };

      const updateUI = () => {
        steps.forEach((step, idx) => step.classList.toggle("active", idx === index));
        labels.forEach((label, idx) => label.classList.toggle("active", idx === index));
        if (currentEl) currentEl.textContent = String(index + 1);
        if (progress) {
          const pct = total === 1 ? 100 : (index / (total - 1)) * 100;
          progress.style.width = `${pct}%`;
        }
        prevBtn.disabled = index === 0;
        prevBtn.style.opacity = index === 0 ? "0.5" : "1";
        nextBtn.style.display = index === total - 1 ? "none" : "inline-flex";
        submitBtn.style.display = index === total - 1 ? "inline-flex" : "none";
        updateRequired();
      };

      const validateStep = () => {
        const currentFields = Array.from(steps[index].querySelectorAll("input, textarea, select"));
        for (const field of currentFields) {
          if (!field.checkValidity()) {
            field.reportValidity();
            return false;
          }
        }
        return true;
      };

      prevBtn.addEventListener("click", () => {
        index = Math.max(0, index - 1);
        updateUI();
      });

      nextBtn.addEventListener("click", () => {
        if (!validateStep()) return;
        if (index === 0) {
          captureLead();
        }
        index = Math.min(total - 1, index + 1);
        updateUI();
      });

      if (exampleBtn) {
        exampleBtn.addEventListener("click", () => {
          loadExample();
        });
      }
      if (aiCheckBtn) {
        aiCheckBtn.addEventListener("click", checkAiHealth);
      }

      fields.forEach((field) => {
        field.addEventListener("input", () => {
          persist();
          updatePreview();
        });
        field.addEventListener("change", () => {
          persist();
          updatePreview();
        });
      });

      form.addEventListener("keydown", (event) => {
        if (event.key !== "Enter") return;
        if (index >= total - 1) return;
        event.preventDefault();
        nextBtn.click();
      });

      if (emailField) {
        emailField.addEventListener("input", scheduleCapture);
        emailField.addEventListener("blur", scheduleCapture);
      }
      if (phoneField) {
        phoneField.addEventListener("change", scheduleCapture);
      }
      if (consentField) {
        consentField.addEventListener("change", scheduleCapture);
      }

      form.addEventListener("submit", (event) => {
        if (index !== total - 1) {
          event.preventDefault();
          return;
        }
        if (!validateStep()) {
          event.preventDefault();
          return;
        }
        try {
          localStorage.removeItem(storageKey);
        } catch (err) {
          // ignore
        }
      });

      restore();
      scheduleCapture();
      updatePreview();
      updateUI();
    }

  </script>
</body>
</html>
